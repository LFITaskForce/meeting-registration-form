<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>Registration form</title>

  <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.css'>
  <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Raleway:400,400i,700'>
  <style>

body {
  margin-bottom: 0px; /* Margin bottom by footer height */
}
.footer {
  margin-top: 40px;
  width: 100%;
  background-color: #f5f5f5;
}

#badge span {
  font-family: "Raleway";
}

#badge {
  position: relative;
  margin: 0 auto;
  width: 4in;
  height: 3in;
  border: 1px solid black;
}

#badge div {
  white-space: nowrap;
  text-align: center;
  width: 100%;
  position: absolute;
  line-height: 0.8;
}
#lname-d,
#sname-d {
  font-weight: bold;
}
#lname-d {
  font-size: 68pt;
  bottom: 2.05in;
}
#sname-d {
  font-size: 26pt;
  font-weight: bold;
  bottom: 1.55in;
}
#affili-d,
#pronoun-d {
  font-size: 22pt;
  bottom: 1.08in;
}
#pronoun-d {
  font-style: italic;
  bottom: 0.64in;
}
#event-d,
#location-d {
  font-size: 7pt;
  bottom: 0.29in;
  left: 0.025in;
}
#location-d {
  bottom: 0.15in;
}

#logo1 {
  width: 92px !important;
  height: 61px;
  /* background-image: url("https://raw.githubusercontent.com/LSSTDESC/name-tag-guru/master/web-static/desc-logo.png"); */
  bottom: 0.02in;
  left: 0.1in;
}

#logo2 {
  width: 64px !important;
  height: 22px;
  /* background-image: url("https://raw.githubusercontent.com/LSSTDESC/name-tag-guru/master/web-static/lsstc-logo.png"); */
  bottom: 0.15in;
  right: 0.2in;
}
  </style>

</head>

<body>

  <div class="container">
  <form action="" method="POST" id="main_form">
    <div class="form-row">
      <div class="form-group col-md-6">
        <label for="first_name">First Name</label>
        <input type="text" class="form-control" name="first_name" id="first_name" placeholder="First Name" maxlength="100" required>
        <div class="invalid-feedback">Please provide your first name.</div>
      </div>
      <div class="form-group col-md-6">
        <label for="last_name">Last Name</label>
        <input type="text" class="form-control" name="last_name" id="last_name" placeholder="Last Name" maxlength="100" required>
        <div class="invalid-feedback">Please provide your last name.</div>
      </div>
    </div>
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" class="form-control" name="email" id="email" placeholder="Email" maxlength="100" required>
        <div class="invalid-feedback">
          Invalid email or already registered.
        </div>
    </div>
    <!-- <div class="form-group">
      <label for="phone">Phone</label>
      <input type="phone" class="form-control" name="phone" id="phone" placeholder="Phone" maxlength="100" required>
        <div class="invalid-feedback">
          Please provide a phone number.
        </div>
    </div> -->
    <div class="form-group">
      <label for="affili">Affiliation</label>
      <input type="text" class="form-control" name="affiliation" id="affili" placeholder="Affiliation" maxlength="100" required>
      <div class="invalid-feedback">Please provide your affiliation.</div>
    </div>

    <hr>
    <h5>Badge information</h5>
    <br>
    <div class="row">
      <div class="col-sm">
        <div class="form-group">
          <label for="lname">Large-font name</label>
          <input type="text" class="form-control" name="lname" id="lname" placeholder="optional, defaults to first name" maxlength="100">
        </div>
        <div class="form-group">
          <label for="sname">Small-font name</label>
          <input type="text" class="form-control" name="sname" id="sname" placeholder="optional, defaults to last name" maxlength="100">
        </div>
        <div class="form-group">
          <label for="pronoun">Third-person pronoun</label>
          <input type="text" class="form-control" name="pronoun" id="pronoun" placeholder="e.g. she/her, he/him, they/them" required maxlength="100">
          <small id="inputPronounHelp" class="form-text text-muted">Third-person pronoun you want people to use to refer to you, such as: they/she/he/ze, or simply just your name.</small>
        <div class="invalid-feedback">Please provide your choice of pronoun.</div>
        </div>
      </div>
      <div class="col-sm">
        <div id="badge">
          <div id="lname-d">
            <span id="lname-s"></span>
          </div>
          <div id="sname-d">
            <span id="sname-s"></span>
          </div>
          <div id="affili-d">
            <span id="affili-s"></span>
          </div>
          <div id="pronoun-d">
            <span id="pronoun-s"></span>
          </div>
          <div id="event-d">
            <span id="event-s">Bay Area LFI Meeting, December 2nd, 2019</span>
          </div>
          <div id="location-d">
            <span id="location-s">Berkeley Institute for Data Science</span>
          </div>
          <div id="logo1" class="logo"></div>
          <div id="logo2" class="logo"></div>
        </div>
      </div>
    </div>

    <hr>
    <h5>Logistics</h5>
    <!-- <div class="form-group">
      <label for="inputAttendance">What days will you attend?</label>
      <div id="Attendance">
      <div class="form-check form-check-inline" id="inputAttendance">
        <input class="form-check-input" type="checkbox" name="attend_mon" id="attend_mon">
        <label class="form-check-label" for="attend_mon">Monday</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="attend_tue" id="attend_tue">
        <label class="form-check-label" for="attend_tue">Tuesday</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox"  name="attend_wed" id="attend_wed">
        <label class="form-check-label" for="attend_wed">Wednesday (Hack)</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox"  name="attend_thu" id="attend_thu">
        <label class="form-check-label" for="attend_thu">Thursday (Hack)</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="attend_fri" id="attend_fri">
        <label class="form-check-label" for="attend_fri">Friday (Hack)</label>
      </div>
        </div>
    </div> -->

    <div class="form-group">
      <label for="dinner_diet">Please indicate any dietary restrictions: </label>
      <input type="text" class="form-control" id="dinner_diet" name="dinner_diet" maxlength="256" placeholder="optional">
    </div>


    <hr>
    <h5>Contributions</h5>
    <div class="form-group">
      <label for="title">If you would like to submit a contribution (20 minutes talk), please povide a title and short abstract:</label>
      <input type="text" class="form-control" id="contrib_title" name="contrib_title" maxlength="512" placeholder="title">
      <textarea class="form-control" id="contrib_abstract" name="contrib_abstract" maxlength="5000" rows="10" placeholder="abstract"></textarea>
    </div>

    <hr>
    <div class="form-group">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="code_of_conduct" id="code_of_conduct" required>
        <label class="form-check-label" for="code_of_conduct">
        I have read, and will abide by, the meeting <a href="https://lfitaskforce.github.io/BerkeleyMeeting/" target="_blank">Code of Conduct</a>.
      </label>
          <div class="invalid-feedback">You must agree to the code of conduct before registering.</div>
      </div>
    </div>
    <div class="form-group" id="register_button">
      <button class="btn btn-primary" type="button" id="register" >Register</button>
  </div>
    <input type="hidden" name="secret" id="secret" value=""/>
  </form>
</div>

<!-- Modal Warning-->
  <div class="modal fade" id="backendModal" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Invalid registration URL</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>The URL for this form does not contain a valid registration link.
            Please contact the LOC for a valid registration URL.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

<!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Registration successful</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="confirmation-content">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="footer">
    <div class="container">
      <dl class="row">
        <span class="text-muted">
  <p class="lead">Privacy notice</p>
  <p>Your <mark>first name, last name, and affiliation will appear on a public webpage</mark> associated with the meeting website. Your badge names, pronoun(s), and your affiliation will appear on your badge. Your email will be used to contact you when necessary. All data collected here may be shared with the organizing committee.
  </p>
         <div class="col-md-12">
          <!--Footer Bottom-->
          <p class="text-md-center"><small>This page uses the <a href="https://github.com/LSSTDESC/name-tag-guru/" target="_blank">badge template</a> designed by <a href="https://yymao.github.com/" target="_blank">Yao-Yuan Mao</a>.
        </div></span>
</dl>
  </div>
</footer>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js'></script>
  <script>

// Registration call
document.getElementById("register").onclick = function(e) {
  $.ajax({
        type : 'POST',
        data: $("#main_form").serialize(),
        url : $("#main_form").attr('action'),
        success : function(data){
            $("#confirmation-content").html(data);
            $("#confirmationModal").modal("show");
        }
    });
  e.preventDefault();
  return false;
}


// Validate the form before authorising checkout
$(function(){
  document.getElementById("register_button").addEventListener("click", function(event) {
    var form = document.getElementById("main_form");

    // Custom checks
    // Check that at least one day is selected
    if($("#Attendance :input").filter(':checked').length >= 1){
      $.each($("#Attendance :input"), function(index, obj){
        obj.setCustomValidity("");
      });
    }else{
      $.each($("#Attendance :input"), function(index, obj){
        obj.setCustomValidity("Select at least one day");
      });
    }

    // If form is not validated, don't trigger the registration
    if(form.checkValidity() === false){
      event.preventDefault();
      event.stopPropagation();
    }
    form.classList.add('was-validated');
}, true);
});

// Function to disable the form if the backend is unavailable
  var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};

var backend = getUrlParameter('backend');
var secret  = getUrlParameter('secret');

$(function(){
  // Disable the form if the required info about backend server is missing
   if((backend === undefined) || (secret === undefined)){
     $("#main_form :input").prop('disabled', true);
     $('#backendModal').modal({show: true});
   }
   $("#main_form").attr('action', backend+'/register');
   $("#secret").attr('value', secret);
});

$("#email").change(function(){
    $.post(backend+"/check_email",
            {email: $(this).val(),
             secret: secret},
            function(data, status){
              var d = document.getElementById("email");
              if (status === "success"){
                if(data === "Ok"){
                  d.setCustomValidity("");
                  d.classList.remove('is-invalid');
                }else{
                  d.setCustomValidity("Already registered.");
                  d.classList.add('is-invalid');
                }
              }else{
                  // Server is unavailable...
                  // make sure we don't block the form at this stage
                  d.setCustomValidity("");
                  d.classList.remove('is-invalid');
                }
              console.log("Data: " + data + "\nStatus: " + status);
            });
});

$("input").keyup(function() {
  var target = $("#" + $(this).attr("id") + "-s");
  target.text($(this).val());
  target.css("font-size", "100%");
  var badge = $("#badge");
  var scale = badge.width() / target.width();
  if (scale < 1) target.css("font-size", (scale * 100).toString() + "%");
});
</script>

</body>

</html>
